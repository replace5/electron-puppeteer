<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Browser.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BoundIpc.html">BoundIpc</a><ul class='methods'><li data-type='method'><a href="BoundIpc.html#off">off</a></li><li data-type='method'><a href="BoundIpc.html#on">on</a></li><li data-type='method'><a href="BoundIpc.html#once">once</a></li><li data-type='method'><a href="BoundIpc.html#send">send</a></li><li data-type='method'><a href="BoundIpc.html#sendOn">sendOn</a></li></ul></li><li><a href="Browser.html">Browser</a><ul class='methods'><li data-type='method'><a href="Browser.html#bringToFront">bringToFront</a></li><li data-type='method'><a href="Browser.html#build">build</a></li><li data-type='method'><a href="Browser.html#close">close</a></li><li data-type='method'><a href="Browser.html#frontPage">frontPage</a></li><li data-type='method'><a href="Browser.html#getBoundingClientRect">getBoundingClientRect</a></li><li data-type='method'><a href="Browser.html#getPageById">getPageById</a></li><li data-type='method'><a href="Browser.html#init">init</a></li><li data-type='method'><a href="Browser.html#newPage">newPage</a></li><li data-type='method'><a href="Browser.html#pages">pages</a></li></ul></li><li></li><li><a href="BrowserManager.html">BrowserManager</a><ul class='methods'><li data-type='method'><a href="BrowserManager.html#frontBrowser">frontBrowser</a></li><li data-type='method'><a href="BrowserManager.html#get">get</a></li><li data-type='method'><a href="BrowserManager.html#launch">launch</a></li></ul></li><li></li><li><a href="ElementHandle.html">ElementHandle</a><ul class='methods'><li data-type='method'><a href="ElementHandle.html#$">$</a></li><li data-type='method'><a href="ElementHandle.html#$$">$$</a></li><li data-type='method'><a href="ElementHandle.html#$$eval">$$eval</a></li><li data-type='method'><a href="ElementHandle.html#$eval">$eval</a></li><li data-type='method'><a href="ElementHandle.html#$x">$x</a></li><li data-type='method'><a href="ElementHandle.html#asElement">asElement</a></li><li data-type='method'><a href="ElementHandle.html#blur">blur</a></li><li data-type='method'><a href="ElementHandle.html#boxModel">boxModel</a></li><li data-type='method'><a href="ElementHandle.html#check">check</a></li><li data-type='method'><a href="ElementHandle.html#click">click</a></li><li data-type='method'><a href="ElementHandle.html#contentFrame">contentFrame</a></li><li data-type='method'><a href="ElementHandle.html#dispose">dispose</a></li><li data-type='method'><a href="ElementHandle.html#executionContext">executionContext</a></li><li data-type='method'><a href="ElementHandle.html#focus">focus</a></li><li data-type='method'><a href="ElementHandle.html#getAttribute">getAttribute</a></li><li data-type='method'><a href="ElementHandle.html#getAttributes">getAttributes</a></li><li data-type='method'><a href="ElementHandle.html#getBoundingClientRect">getBoundingClientRect</a></li><li data-type='method'><a href="ElementHandle.html#getProperties">getProperties</a></li><li data-type='method'><a href="ElementHandle.html#getProperty">getProperty</a></li><li data-type='method'><a href="ElementHandle.html#hover">hover</a></li><li data-type='method'><a href="ElementHandle.html#isIntersectingViewport">isIntersectingViewport</a></li><li data-type='method'><a href="ElementHandle.html#jsonValue">jsonValue</a></li><li data-type='method'><a href="ElementHandle.html#press">press</a></li><li data-type='method'><a href="ElementHandle.html#screenshot">screenshot</a></li><li data-type='method'><a href="ElementHandle.html#tap">tap</a></li><li data-type='method'><a href="ElementHandle.html#toString">toString</a></li><li data-type='method'><a href="ElementHandle.html#type">type</a></li><li data-type='method'><a href="ElementHandle.html#uncheck">uncheck</a></li><li data-type='method'><a href="ElementHandle.html#uploadFile">uploadFile</a></li></ul></li><li></li><li><a href="EventEmitter.html">EventEmitter</a><ul class='methods'><li data-type='method'><a href="EventEmitter.html#.noConflict">noConflict</a></li></ul></li><li><a href="Frame.html">Frame</a><ul class='methods'><li data-type='method'><a href="Frame.html#addScriptTag">addScriptTag</a></li><li data-type='method'><a href="Frame.html#addStyleTag">addStyleTag</a></li><li data-type='method'><a href="Frame.html#blur">blur</a></li><li data-type='method'><a href="Frame.html#childFrames">childFrames</a></li><li data-type='method'><a href="Frame.html#click">click</a></li><li data-type='method'><a href="Frame.html#content">content</a></li><li data-type='method'><a href="Frame.html#evaluate">evaluate</a></li><li data-type='method'><a href="Frame.html#focus">focus</a></li><li data-type='method'><a href="Frame.html#goto">goto</a></li><li data-type='method'><a href="Frame.html#hover">hover</a></li><li data-type='method'><a href="Frame.html#isDetached">isDetached</a></li><li data-type='method'><a href="Frame.html#localStorageGet">localStorageGet</a></li><li data-type='method'><a href="Frame.html#localStorageKeys">localStorageKeys</a></li><li data-type='method'><a href="Frame.html#localStorageRemove">localStorageRemove</a></li><li data-type='method'><a href="Frame.html#localStorageSet">localStorageSet</a></li><li data-type='method'><a href="Frame.html#name">name</a></li><li data-type='method'><a href="Frame.html#page">page</a></li><li data-type='method'><a href="Frame.html#parentFrame">parentFrame</a></li><li data-type='method'><a href="Frame.html#select">select</a></li><li data-type='method'><a href="Frame.html#setContent">setContent</a></li><li data-type='method'><a href="Frame.html#tap">tap</a></li><li data-type='method'><a href="Frame.html#title">title</a></li><li data-type='method'><a href="Frame.html#type">type</a></li><li data-type='method'><a href="Frame.html#url">url</a></li><li data-type='method'><a href="Frame.html#waitFor">waitFor</a></li><li data-type='method'><a href="Frame.html#waitForFunction">waitForFunction</a></li><li data-type='method'><a href="Frame.html#waitForNavigation">waitForNavigation</a></li><li data-type='method'><a href="Frame.html#waitForSelector">waitForSelector</a></li><li data-type='method'><a href="Frame.html#waitForXPath">waitForXPath</a></li></ul></li><li></li><li><a href="Ipc.html">Ipc</a><ul class='methods'><li data-type='method'><a href="Ipc.html#off">off</a></li><li data-type='method'><a href="Ipc.html#on">on</a></li><li data-type='method'><a href="Ipc.html#once">once</a></li><li data-type='method'><a href="Ipc.html#send">send</a></li><li data-type='method'><a href="Ipc.html#sendOn">sendOn</a></li></ul></li><li></li><li><a href="Page.html">Page</a><ul class='methods'><li data-type='method'><a href="Page.html#bringToFront">bringToFront</a></li><li data-type='method'><a href="Page.html#browser">browser</a></li><li data-type='method'><a href="Page.html#build">build</a></li><li data-type='method'><a href="Page.html#canGoBack">canGoBack</a></li><li data-type='method'><a href="Page.html#canGoForward">canGoForward</a></li><li data-type='method'><a href="Page.html#close">close</a></li><li data-type='method'><a href="Page.html#cookies">cookies</a></li><li data-type='method'><a href="Page.html#deleteCookies">deleteCookies</a></li><li data-type='method'><a href="Page.html#evaluateHandle">evaluateHandle</a></li><li data-type='method'><a href="Page.html#find">find</a></li><li data-type='method'><a href="Page.html#frames">frames</a></li><li data-type='method'><a href="Page.html#goBack">goBack</a></li><li data-type='method'><a href="Page.html#goForward">goForward</a></li><li data-type='method'><a href="Page.html#init">init</a></li><li data-type='method'><a href="Page.html#isClosed">isClosed</a></li><li data-type='method'><a href="Page.html#isLoading">isLoading</a></li><li data-type='method'><a href="Page.html#isLoadingMainFrame">isLoadingMainFrame</a></li><li data-type='method'><a href="Page.html#mainFrame">mainFrame</a></li><li data-type='method'><a href="Page.html#queryObjects">queryObjects</a></li><li data-type='method'><a href="Page.html#reload">reload</a></li><li data-type='method'><a href="Page.html#screenshot">screenshot</a></li><li data-type='method'><a href="Page.html#setCookie">setCookie</a></li><li data-type='method'><a href="Page.html#waitForRequest">waitForRequest</a></li><li data-type='method'><a href="Page.html#waitForResponse">waitForResponse</a></li></ul></li><li></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">Browser.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Browser类
 */

const {remote} = require('electron');
const {Menu, MenuItem} = remote;
const Mousetrap = require('mousetrap');

import EventEmitter from "./EventEmitter.js"
import { uniqueId, importStyle } from "./util.js"
import Page from "./Page.js"
import ChromeTabs from "./libs/chrome-tabs/chrome-tabs.js"
import ChromeTabsCSS from "./libs/chrome-tabs/chrome-tabs.css.js"
import {loadingGif, faviconPng} from "./images.js"
import BrowserManager from "./BrowserManager.js";
importStyle(ChromeTabsCSS)

/**
 * @class Browser
 * @extends EventEmitter
 * 
 * @property {string} id browser实例的唯一id
 * @property {boolean} isFront 是否为激活状态
 * @property {BrowserManager} browserManager
 * @property {Object} options 传入的配置信息
 */
export default class Browser extends EventEmitter {
	/**
	 * Browser构造函数
   * @constructor Browser
	 * 
	 * @param {BrowserManager} browserManager
	 * @param {Object} options 传入配置
	 * @param {Element} options.container DOM容器 
	 * @param {boolean} [options.devtools] 是否打开控制台 
	 * @param {string} [options.partition] session标识，相同的partition共享登录状态
	 * @param {string} options.preload preload, 理论上必须为当前包的preload/webivew.preload.js, 否则无法通信
	 * @param {string} [options.startUrl] 新建tab的初始页面, 不传则为abount:blank
	 * @param {string} [options.startUrlReferrer] 打开的startUrl的referrer
	 * @param {string} [options.webpreferences] 网页功能的设置
	 */
	constructor(browserManager, options) {
		super()

		this.id = uniqueId('browser_')
		this._pages = []
		this.browserManager = browserManager
		this.options = options
	}
	/**
	 * Browser的初始化
	 * @async
	 */
	async init() {
		this.build()
		await this.newPage()
	}
	/**
	 * 获取browser相对于视窗的信息
	 */
	getBoundingClientRect() {
		return this.doms.pagesContainer.getBoundingClientRect()
	}
	/**
	 * Browser的构建
	 */
	build() {
		const template = `
			&lt;div class="electron-puppeteer-browser">
				&lt;div class="chrome-tabs">
					&lt;div class="chrome-tabs-content">&lt;/div>
					&lt;div class="chrome-tabs-content-add">
						&lt;svg viewBox="64 64 896 896" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class="">&lt;path d="M482 152h60q8 0 8 8v704q0 8-8 8h-60q-8 0-8-8V160q0-8 8-8z">&lt;/path>&lt;path d="M176 474h672q8 0 8 8v60q0 8-8 8H176q-8 0-8-8v-60q0-8 8-8z">&lt;/path>&lt;/svg>
					&lt;/div>
					&lt;div class="chrome-tabs-bottom-bar">&lt;/div>
				&lt;/div>
				&lt;div class="electron-puppeteer-pages">
				&lt;/div>
			&lt;/div>
		`

		const div = document.createElement('div')
    div.innerHTML = template
		this.element = div.firstElementChild
		this.options.container.appendChild(this.element)
		
		this.doms = {
			tabsElm: this.element.querySelector('.chrome-tabs'),
			addBtn: this.element.querySelector('.chrome-tabs-content-add'),
			pagesContainer: this.element.querySelector('.electron-puppeteer-pages')
		}

		this._initChromeTabs()
		this._bindShortcuts()
	}
	/**
	 * 初始化顶部tab
	 * @private
	 */
	_initChromeTabs() {
		let chromeTabs = this._chromeTabs = new ChromeTabs()
		chromeTabs.init(this.doms.tabsElm)
		this.doms.tabsElm.addEventListener('activeTabChange', (evt) => {
			if (!evt.detail.trigger) {
				var pageId = evt.detail.tabEl.getAttribute('data-tab-id');
				var page = this.getPageById(pageId);
				page.bringToFront();
			}
		})
		this.doms.tabsElm.addEventListener('tabRemove', (evt) => {
			if (!evt.detail.trigger) {
				var pageId = evt.detail.tabEl.getAttribute('data-tab-id');
				var page = this.getPageById(pageId)
				page.$tabEl = null
				page.close()
			}
		})

		this.doms.addBtn.addEventListener('click', () => {
			this.newPage()
		})
	}
	/**
	 * 绑定快捷键
	 * @private
	 */
	_bindShortcuts() {
		this.shortcuts = [
			{
				action: "closePage",
				prevent : true,
				keys: ["command+w", "ctrl+w"],
				callback: () => {
					let frontPage = this.frontPage()
					if (this.isFront &amp;&amp; frontPage) {
						frontPage.close()
					}
				}
			},
			{
				action: "newPage",
				prevent : true,
				keys: ["command+t", "ctrl+t"],
				callback: () => {
					if (this.isFront) {
						this.newPage()
					}
				}
			},
			{
				action: "reload",
				prevent : true,
				keys: ["f5"],
				callback: () => {
					let frontPage = this.frontPage()
					if (this.isFront &amp;&amp; frontPage &amp;&amp; frontPage.isReady) {
						frontPage.reload()
					}
				}
			},
			{
				action: "toggleDevtools",
				prevent : true,
				keys: ["command+option+i", "ctrl+shift+i", "f12"],
				callback: () => {
					let frontPage = this.frontPage()
					if (this.isFront &amp;&amp; frontPage &amp;&amp; frontPage.isReady) {
						if (frontPage.webview.isDevToolsOpened()) {
							frontPage.webview.closeDevTools()
						} else {
							frontPage.webview.openDevTools()
						}
					}
				}
			},
		]

		this.shortcuts.forEach(item => {
			Mousetrap.bind(item.keys, () => {
				if (item.callback) {
					item.callback.call(this)
				}
				if (item.prevent) {
					return false
				}
			})
		})

		Mousetrap.bind('?', (evt) => {
			console.log('show shortcuts!', evt)
		})
	}
	_doBack() {
		this.isFront = false
		this.element.style.display = 'none'
	}
	_doFront() {
		this.isFront = true
		this.element.style.display = ''
		// 每次切换browser的时候强制重新布局，防止当前browser不可见时导致的tab样式错乱
		this._chromeTabs.layoutTabs()
	}
	/**
	 * 将browser提到视窗最前端，相当于多个browser，切换到当前
	 */
	bringToFront() {
		this.browserManager._bringBrowserToFront(this.id)
		this.emit('bringToFront', this.id)
	}
	/**
	 * 关闭browser
	 */
	close() {
		this._pages.forEach(page => {
			page.close()
		})

		this.options.container.removeChild(this.element)
		this.browserManager._removeBrowser(this.id)
		this.emit('close', this.id)
	}
	/**
	 * 获取browser下的所有page实例集合
	 * @async
	 * 
	 * @return {Page[]}
	 */
	async pages() {
		return this._pages.slice(0)
	}
	/**
	 * 通过pageid获取指定page实例
	 * 
	 * @return {Page}
	 */
	getPageById(pageId) {
		return this._pages.find(item => item.id === pageId)
	}
	/**
	 * 获取当前激活的page
	 * 
	 * @return {Page}
	 */
	frontPage() {
		return this._pages.find(item => item.isFront === true)
	}
	/**
	 * 新建页面
	 * @async
	 * @param {string} [url] 页面跳转地址，不传则跳转到browser的startUrl
	 * @param {string} [referer] referrer，不传则为browser的startUrlReferrer
	 * 
	 * @return {Promise&lt;Page>} 返回构建的page实例
	 */
	async newPage(url, referer) {
		var page = new Page(this, {
			container: this.doms.pagesContainer,
			partition: this.options.partition,
			devtools: this.options.devtools,
			preload: this.options.preload,
			startUrl: url || this.options.startUrl,
			startUrlReferrer: referer || this.options.startUrlReferrer,
		})
		page._injectShortcuts(this.shortcuts.slice(0))
		await page.init()
		this._pages.push(page)
		this._handlePageTab(page)
		await page.bringToFront()

		this.emit('newPage', page)
		return page
	}
	/**
	 * page对应tab的右键菜单，图标及标题的更新
	 * @private
	 * @param {Page} page 
	 */
	_handlePageTab(page) {
		let elm = page.$tabEl = this._chromeTabs.addTab({
			id: page.id,
			title: "加载中……",
			favicon: faviconPng
		}, {
			background: true
		})

		elm.addEventListener('contextmenu', (evt) => {
			this._showTabMenu(page)
		})

		let iconSet = false
		page.on('loading-start', () => {
			iconSet = false
			this._chromeTabs.updateTab(page.$tabEl, {
				favicon: loadingGif
			})
		})
		page.on('favicon-updated', (evt) => {
			iconSet = true
			this._chromeTabs.updateTab(page.$tabEl, {
				favicon: evt.favicon
			})
			var img = new Image();
			img.src = evt.favicon;
			img.onerror = () => {
				this._chromeTabs.updateTab(page.$tabEl, {
					favicon: faviconPng
				});
				img.onerror = null;
				img = null;
			}
		})
		page.on('title-updated', (evt) => {
			this._chromeTabs.updateTab(page.$tabEl, {
				title: evt.title
			})
		})
		page.on('loading-end', () => {
			if (!iconSet) {
				this._chromeTabs.updateTab(page.$tabEl, {
					favicon: faviconPng
				})
			}
		})
		page.on('new-window', async (evt) => {
			let url = page.url()
			let pageNew = await this.newPage()
			await pageNew.goto(evt.url, {
				referer: url
			})
		})
	}
	/**
	 * tab的右键菜单
	 * @private
	 * @param {Page} page 
	 */
	_showTabMenu(page) {
		//右键菜单
		const menu = new Menu();
		menu.append(new MenuItem({
			label: '刷新                  F5',
			click: () => {
				page.reload()
			}
		}));
		menu.append(new MenuItem({
			label: '复制',
			click:  () => {
				this.newPage(page.url(), page.url())
			}
		}));
		menu.append(new MenuItem({
			type: 'separator',
		}));
		menu.append(new MenuItem({
			label: '前进',
			enabled: page.canGoForward(),
			click: () => {
				page.goForward();
			}
		}));
		menu.append(new MenuItem({
			label: '后退',
			enabled: page.canGoBack(),
			click: () => {
				page.goBack();
			}
		}));
		menu.append(new MenuItem({
			type: 'separator',
		}));
		menu.append(new MenuItem({
				label: '关闭                  Ctrl+W',
				click: () => {
					page.close()
				}
		}));
		menu.append(new MenuItem({
			label: '关闭其它',
			click: () => {
				this._pages.filter(item => item.id !== page.id).forEach(item => item.close())
			}
		}));
		menu.popup({window: remote.getCurrentWindow()})
	}
	/**
	 * 删除页面，不可直接调用
	 * 如需要关闭页面，请调用page.close()
	 * @private
	 * @param {string} pageId 
	 */
	_removePage(pageId) {
		var index = this._pages.findIndex(page => page.id === pageId)
		var page = this._pages[index]
		this._pages.splice(index, 1)
		if (page.$tabEl) {
			this._chromeTabs.removeTab(page.$tabEl, true)
		}

		if (!page.isFront) {
			return
		}

		var nextPage = this._pages[index] || this._pages[index - 1]
		if (nextPage) {
			nextPage.bringToFront()
		}
	}
	/**
	 * 激活页面，不可直接调用
	 * 如需要激活页面，请调用page.bringToFront()
	 * @private
	 * @param {string} pageId 
	 */
	_bringPageToFront(pageId) {
		this._pages.forEach(page => {
			if (pageId === page.id) {
				this._chromeTabs.setCurrentTab(page.$tabEl, true)
				page._doFront()
			} else {
				page._doBack()
			}
		})
	}
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Fri May 08 2020 20:40:12 GMT+0800 (GMT+08:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
